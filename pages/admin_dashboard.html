<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>×œ×‘ ×§×˜×Ÿ - × ×™×”×•×œ ××“××™×Ÿ</title>
    <link rel="icon" href="../images/transparent logo.png" type="image/png">
    <style>
        /* Shared Variables - Unified Look */
        :root {
            --bg-color: #f4f4f4;
            --header-bg: white;
            --text-color: #333;
            --card-bg: white;
            --nav-btn-bg: #f0f0f0;
            --nav-btn-text: #555;
            --nav-btn-hover: #e0e0e0;
            --border-color: #eee;
            --table-head-bg: #eee;
        }

        body.dark-mode {
            --bg-color: #121212;
            --header-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --card-bg: #2D2D2D;
            --nav-btn-bg: #333;
            --nav-btn-text: #ddd;
            --nav-btn-hover: #444;
            --border-color: #444;
            --table-head-bg: #333;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            transition: background 0.3s;
        }

        .top-bar {
            background: var(--header-bg);
            color: var(--text-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* UNIFIED NAV BUTTONS */
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            text-decoration: none;
            color: var(--nav-btn-text);
            font-size: 14px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--nav-btn-bg);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .nav-item:hover {
            background: var(--nav-btn-hover);
            color: var(--text-color);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .theme-toggle:hover {
            background: rgba(128, 128, 128, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Settings Panel Styling */
        .settings-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: background 0.3s, border 0.3s;
        }

        .settings-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            /* Adapts to dark/light bg */
            color: var(--text-color);
        }

        /* Controls Bar for Sort & Filter */
        .controls-bar {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--text-color);
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            background: var(--bg-color);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .sort-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: var(--table-head-bg);
            padding: 12px;
            text-align: right;
            border-bottom: 2px solid var(--border-color);
            font-weight: bold;
            color: var(--text-color);
            opacity: 0.8;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .btn-delete {
            background: #FFEBEE;
            color: #D32F2F;
            border: 1px solid #FFCDD2;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-delete:hover {
            background: #FFCDD2;
        }

        .logout-btn {
            background: #FF4444;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #D32F2F;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="brand-area">
            <img src="../images/logo.png" alt="Logo" class="brand-logo">
            <span style="font-weight:bold; font-size:18px;">×¤×× ×œ × ×™×”×•×œ</span>
        </div>

        <div class="nav-actions">
            <a href="user_dashboard.html" class="nav-item">ğŸª‘ ×§×˜×œ×•×’</a>
            <a href="employee_dashboard.html" class="nav-item">ğŸ› ï¸ ×××©×§ ×¢×•×‘×“</a>

            <span id="userGreeting"
                style="margin: 0 5px; font-weight:600; color:var(--text-color); opacity:0.7;"></span>
            <button class="theme-toggle" onclick="toggleTheme()" title="××¦×‘ ××•×—×©×š">ğŸŒ“</button>
            <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="container">
        <div class="settings-panel">
            <h3 style="margin-top:0; color: var(--text-color);">âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
            <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                <div>
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">××§×¡' ×™××™ ×”×©××œ×”:</label>
                    <input type="number" id="settingMaxDays" class="settings-input">
                </div>
                <div>
                    <label style="display:block; font-weight:bold; margin-bottom:5px;">××§×¡' ×¤×¨×™×˜×™× ×œ××©×ª××©:</label>
                    <input type="number" id="settingMaxItems" class="settings-input">
                </div>
                <button onclick="saveSettings()"
                    style="background: #FF69B4; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª
                </button>
            </div>
        </div>

        <h2 style="border-bottom: 2px solid #FF69B4; padding-bottom: 10px; color: var(--text-color);">××©×ª××©×™× ×¨×©×•××™×
        </h2>

        <div class="controls-bar">
            <div class="control-group">
                <label class="filter-label">××™×•×Ÿ ×œ×¤×™:</label>
                <select id="sortSelect" class="sort-select" onchange="renderTable()">
                    <option value="id">ğŸ”¢ ××¡×¤×¨ ×¡×™×“×•×¨×™ (×¡×“×¨ ×¢×•×œ×”)</option>
                    <option value="name_asc">ğŸ”¤ ×©× ××œ× (×¡×“×¨ ×¢×•×œ×”)</option>
                    <option value="name_desc">ğŸ”¤ ×©× ××œ× (×¡×“×¨ ×™×•×¨×“)</option>
                    <option value="username_asc">ğŸ‘¤ ×©× ××©×ª××© (×¡×“×¨ ×¢×•×œ×”)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="filter-label">×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×¤×§×™×“×™×:</label>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" class="role-filter" value="admin" checked onchange="renderTable()">
                        ×× ×”×œ×™×
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="role-filter" value="employee" checked onchange="renderTable()">
                        ×¢×•×‘×“×™×
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="role-filter" value="user" checked onchange="renderTable()">
                        ××©×ª××©×™×
                    </label>
                </div>
            </div>
        </div>

        <table id="usersTable">
            <thead>
                <tr>
                    <th>××¡×¤×¨ ×¡×™×“×•×¨×™</th>
                    <th>×©× ××œ×</th>
                    <th>×©× ××©×ª××©</th>
                    <th>×˜×œ×¤×•×Ÿ</th>
                    <th>××™××™×™×œ</th>
                    <th>×ª×¤×§×™×“</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const API_URL = "https://levkatan-api-dxh8azfdfua6e9gn.israelcentral-01.azurewebsites.net/api";
        const token = localStorage.getItem('userToken');
        const username = localStorage.getItem('username');

        // --- Theme Logic ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        // -------------------

        if (!token || localStorage.getItem('userRole') !== 'admin') window.location.href = 'login_page.html';
        document.getElementById('userGreeting').innerText = `${username}`;

        let allUsers = []; // Store users globally

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allUsers = await res.json();
                renderTable(); // Initial render
            } catch (e) {
                console.error("Error loading users:", e);
                alert("Failed to load users.");
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const sortValue = document.getElementById('sortSelect').value;

            // Get selected roles
            const selectedRoles = Array.from(document.querySelectorAll('.role-filter:checked'))
                .map(cb => cb.value);

            // 1. Filter
            let filtered = allUsers.filter(u => selectedRoles.includes(u.role));

            // 2. Sort
            filtered.sort((a, b) => {
                if (sortValue === 'id') {
                    return a.id - b.id;
                } else if (sortValue === 'name_asc') {
                    return a.full_name.localeCompare(b.full_name, 'he');
                } else if (sortValue === 'name_desc') {
                    return b.full_name.localeCompare(a.full_name, 'he');
                } else if (sortValue === 'username_asc') {
                    return a.username.localeCompare(b.username);
                }
                return 0;
            });

            // 3. Render
            tbody.innerHTML = filtered.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.full_name}</td>
                    <td>${u.username}</td>
                    <td>${u.phone_number || '-'}</td>
                    <td>${u.email}</td>
                    <td>
                        <select onchange="changeRole(${u.id}, this.value)" style="padding:4px; border-radius:4px;">
                            <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="employee" ${u.role === 'employee' ? 'selected' : ''}>Employee</option>
                            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-delete" onclick="deleteUser(${u.id})">
                            ğŸ—‘ï¸ ××—×§ ××©×ª××©
                        </button>
                    </td>
                </tr>
            `).join('');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No users found matching the criteria.</td></tr>';
            }
        }

        async function changeRole(id, newRole) {
            await fetch(`${API_URL}/admin/users/${id}/role`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ role: newRole })
            });
            alert("×ª×¤×§×™×“ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”");
        }

        async function deleteUser(id) {
            if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××©×ª××© ×–×”? ×”×¤×¢×•×œ×” ×”×™× ×¡×•×¤×™×ª.")) return;
            await fetch(`${API_URL}/admin/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadUsers();
        }

        async function loadSettings() {
            try {
                const res = await fetch(`${API_URL}/config`);
                const data = await res.json();
                document.getElementById('settingMaxDays').value = data.max_borrow_days;
                document.getElementById('settingMaxItems').value = data.max_borrow_items;
            } catch (e) { console.error("Error loading settings"); }
        }

        async function saveSettings() {
            const maxDays = document.getElementById('settingMaxDays').value;
            const maxItems = document.getElementById('settingMaxItems').value;

            try {
                const res = await fetch(`${API_URL}/admin/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ max_borrow_days: maxDays, max_borrow_items: maxItems })
                });
                if (res.ok) alert("×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!");
                else alert("×©×’×™××” ×‘×©××™×¨×”");
            } catch (e) { alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª"); }
        }

        // Call this on load
        loadSettings();

        function logout() { localStorage.clear(); window.location.href = 'login_page.html'; }
        loadUsers();
    </script>
</body>

</html>