<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×œ×‘ ×§×˜×Ÿ - × ×™×”×•×œ ×”××¢×¨×›×ª</title>
    <link rel="icon" href="../images/transparent logo.png" type="image/png">
    <style>
        /* Shared variables for Unified Look */
        :root {
            --bg-color: #E0F7FA;
            --header-bg: white;
            --text-color: #333;
            --card-bg: white;
            --nav-btn-bg: #f0f0f0;
            --nav-btn-text: #555;
            --nav-btn-hover: #e0e0e0;
            --border-color: #ddd;
            --table-head-bg: #f9f9f9;
            --brand-pink: #FF69B4;
            --brand-pink-hover: #E05297;
        }
        body.dark-mode {
            --bg-color: #121212;
            --header-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --card-bg: #2D2D2D;
            --nav-btn-bg: #333;
            --nav-btn-text: #ddd;
            --nav-btn-hover: #444;
            --border-color: #444;
            --table-head-bg: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; transition: background 0.3s; }

        /* HEADER STYLES */
        .top-bar {
            background: var(--header-bg); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2px;
        }
        .brand-area { display: flex; align-items: center; gap: 10px; }
        .brand-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .nav-actions { display: flex; align-items: center; gap: 10px; }
        .nav-item {
            text-decoration: none; color: var(--nav-btn-text); font-size: 14px; font-weight: 600;
            padding: 8px 16px; border-radius: 20px; background: var(--nav-btn-bg);
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 5px;
        }
        .nav-item:hover { background: var(--nav-btn-hover); color: var(--text-color); }

        .theme-toggle { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; border-radius: 50%; margin-left: 10px; }
        .logout-btn { background: #FF4444; color: white; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .logout-btn:hover { background: #D32F2F; }

        /* TABS STYLE */
        .tabs { display: flex; background: var(--header-bg); justify-content: center; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .tab { padding: 15px 40px; cursor: pointer; font-weight: 600; color: #888; border-bottom: 3px solid transparent; font-size: 16px; transition: all 0.3s; }
        .tab:hover { background: rgba(0,0,0,0.05); color: var(--brand-pink); }
        .tab.active { color: var(--brand-pink); border-bottom-color: var(--brand-pink); }

        /* CONTAINER & CARDS */
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; padding-bottom: 80px; }
        .card { background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }

        h3 { margin-top: 0; color: var(--text-color); border-bottom: 2px solid var(--brand-pink); padding-bottom: 10px; display: inline-block; }
        h4 { margin-bottom: 15px; color: var(--text-color); opacity: 0.9; }

        /* FORM STYLES */
        .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .form-control, select, textarea, input {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;
            background: var(--bg-color); color: var(--text-color); box-sizing: border-box; font-family: inherit;
        }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        th { background-color: var(--table-head-bg); color: #555; font-weight: bold; font-size: 14px; }
        body.dark-mode th { color: #ccc; }

        /* UNIFIED BUTTON STYLES */

        .btn-primary {
            background: var(--brand-pink); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px; width: auto;
        }
        .btn-primary:hover { background: var(--brand-pink-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3); }

        .btn-edit { background: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 5px; }
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        .btn-delete, .btn-reject { background: #FFEBEE; color: #D32F2F; border: 1px solid #FFCDD2; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
            margin-left: 5px;
        .btn-approve { background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 5px; }
        }
        .btn-cancel { background: #f5f5f5; color: #333; border: 1px solid #ccc; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-edit:hover { background: #BBDEFB; }
        /* Floating Action Button (FAB) */
        /* Delete/Reject - Soft Red */
        .fab-btn {
        .btn-delete, .btn-reject {
            position: fixed;
            bottom: 30px;
            left: 30px; /* RTL - Start side */
            width: 60px;
            height: 60px;
            background-color: var(--brand-pink);
            background: #FFEBEE; color: #D32F2F; border: 1px solid #FFCDD2;
            color: white;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            z-index: 90;
        }
        }
        .fab-btn:hover { background-color: var(--brand-pink-hover); transform: scale(1.1); }
        .btn-delete:hover, .btn-reject:hover { background: #FFCDD2; }
        /* Modal Styles */
        /* Approve - Soft Green */
        .modal {
        .btn-approve {
            display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%;
            background: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7;
            overflow:auto; background-color:rgba(0,0,0,0.4);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
            animation: fadeIn 0.3s;
            margin-left: 5px;
        }
        }
        .btn-approve:hover { background: #C8E6C9; }
        /* Cancel (in Modal) - Grey */
        .modal-content {
        .btn-cancel {
            background-color:var(--card-bg); margin:5% auto; padding:30px; border-radius:15px;
            background: #f5f5f5; color: #333; border: 1px solid #ccc;
            border:1px solid var(--border-color); width:90%; max-width:550px;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn-cancel:hover { background: #e0e0e0; }
        /* Checkbox styling within Form Group */
        .checkbox-wrapper {
            display: flex; align-items: center; gap: 8px; margin-top: 5px;
            font-size: 14px; font-weight: normal; color: var(--text-color); cursor: pointer;
        }
        .checkbox-wrapper input[type="checkbox"] { width: auto; transform: scale(1.2); cursor: pointer; }

    </style>
</head>
<body>
    <div class="top-bar">
        <div class="brand-area">
            <img src="../images/logo.png" alt="Logo" class="brand-logo">
            <h2 style="margin:0; font-size: 20px; color:var(--text-color);">×××©×§ ×¢×•×‘×“</h2>
        </div>
        <div class="nav-actions">
            <span id="dynamicNav"></span>
            <a href="user_dashboard.html" class="nav-item">ğŸª‘ ×§×˜×œ×•×’</a>
            <span id="userGreeting" style="margin: 0 5px; font-weight:600; color:var(--text-color); opacity:0.7;"></span>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
            <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('inventory')">ğŸ› ï¸ × ×™×”×•×œ ××œ××™</div>
        <div class="tab" onclick="switchTab('requests')">ğŸ ×‘×§×©×•×ª ×”×©××œ×”</div>
        <div class="tab" onclick="switchTab('donations')">ğŸ’ ×‘×§×©×•×ª ×ª×¨×•××”</div>
        <div class="tab" onclick="switchTab('extensions')">â³ ×‘×§×©×•×ª ×”××¨×›×”</div>
    </div>

    <div class="container">
        <div id="inventory-view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <h3>×¨×©×™××ª ××•×¦×¨×™×</h3>

                    <div style="display: flex; gap: 10px;">
                        <select id="filterCategory" onchange="filterProducts()" style="width: auto; min-width: 150px;">
                            <option value="all">  ×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                            <option value="strollers">×¢×’×œ×•×ª</option>
                            <option value="cribs">×¢×¨×™×¡×•×ª</option>
                            <option value="car seats">××•×©×‘×™ ×‘×˜×™×—×•×ª</option>
                            <option value="toys">×¦×¢×¦×•×¢×™×</option>
                            <option value="baby beds">××™×˜×ª ×ª×™× ×•×§</option>
                        </select>

                        <select id="filterStatus" onchange="filterProducts()" style="width: auto; min-width: 150px;">
                            <option value="all"> ×›×œ ×”×¡×˜×˜×•×¡×™× </option>
                            <option value="available">×–××™×Ÿ</option>
                            <option value="borrowed">××•×©××œ</option>
                            <option value="unavailable">×œ× ×–××™×Ÿ</option>
                            <option value="confirmation_pending">×××ª×™×Ÿ ×œ××™×©×•×¨</option>
                        </select>
                    </div>
                </div>

                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×¡×™×“×•×¨×™</th>
                            <th>×©× ×”××•×¦×¨</th>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th> ××•×©××œ ×œ</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>

            <button class="fab-btn" onclick="openAddModal()">+</button>
        </div>

        <div id="requests-view" class="card" style="display:none;">
            <h3>×‘×§×©×•×ª ×”×©××œ×” ×××ª×™× ×•×ª ×œ××™×©×•×¨</h3>
            <table id="requestsTable">
                <thead>
                    <tr>
                        <th>×©× ×”××©×ª××©</th>
                        <th>×”××•×¦×¨</th>
                        <th>×ª××¨×™×š ×‘×§×©×”</th>
                        <th>×ª××¨×™×š ×”×—×–×¨×” ××©×•×¢×¨</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody"></tbody>
            </table>
        </div>
        
        <div id="donations-view" class="card" style="display:none;">
            <h3>×‘×§×©×•×ª ×ª×¨×•××”</h3>
            <table id="donationsTable">
                <thead>
                    <tr>
                        <th>×ª××¨×™×š ×”×‘×§×©×”</th>
                        <th>×©× ×”××•×¦×¨</th>
                        <th>××™××™×™×œ ×”×ª×•×¨×</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="donationsTableBody"></tbody>
            </table>
        </div>
        
        <div id="extensions-view" class="card" style="display:none;">
            <h3>×‘×§×©×•×ª ×œ×”××¨×›×ª ×”×©××œ×”</h3>
            <table id="extensionsTable">
                <thead>
                    <tr>
                        <th>×©× ×”××©×ª××©</th>
                        <th>××•×¦×¨</th>
                        <th>×ª××¨×™×š ×”×—×–×¨×” × ×•×›×—×™</th>
                        <th>×ª××¨×™×š ××‘×•×§×© ×—×“×©</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="extensionsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="addProductModal" class="modal">
    <div id="editModal" style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4);">
        <div class="modal-content">
        <div style="background-color:var(--card-bg); margin:5% auto; padding:30px; border-radius:15px; border:1px solid var(--border-color); width:90%; max-width:500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;">×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="product_name">×©× ×”××•×¦×¨</label>
                    <input type="text" id="product_name" required>
                </div>
                <div class="form-group">
                    <label for="category">×§×˜×’×•×¨×™×”</label>
                    <select id="category" required>
                        <option value="" disabled selected>×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                        <option value="strollers">×¢×’×œ×•×ª</option>
                        <option value="cribs">×¢×¨×™×¡×•×ª</option>
                        <option value="car seats">××•×©×‘×™ ×‘×˜×™×—×•×ª</option>
                        <option value="toys">×¦×¢×¦×•×¢×™×</option>
                        <option value="baby beds">××™×˜×ª ×ª×™× ×•×§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">×ª×™××•×¨ ×”××•×¦×¨</label>
                    <textarea id="description" rows="3" maxlength="200" required></textarea>
                </div>
                <div class="form-group">
                    <label for="donator_username">×©× ××©×ª××© ×©×œ ×”×ª×•×¨×</label>
                    <input list="usernamesList" type="username" id="donator_username" placeholder="×”×§×œ×“ ××• ×‘×—×¨ ××”×¨×©×™××”" required>
                    <datalist id="usernamesList"></datalist>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="orgCheckbox" onchange="toggleOrg()">
                        ×¢××•×ª×ª ×œ×‘ ×§×˜×Ÿ
                    </label>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="submit" class="btn-primary" style="flex:1">â• ×”×•×¡×¤×ª ×”××•×¦×¨</button>
                    <button type="button" onclick="document.getElementById('addProductModal').style.display='none'" class="btn-cancel">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">×¢×¨×•×š ×¤×¨×˜×™ ××•×¦×¨ <span id="editProductId" style="font-size:16px; opacity:0.6;"></span></h3>

            <form id="editProductForm">
                <input type="hidden" id="edit_id">

                <div class="form-group">
                    <label for="edit_product_name">×©× ×”××•×¦×¨</label>
                    <input type="text" id="edit_product_name" required>
                </div>

                <div class="form-group">
                    <label for="edit_category">×§×˜×’×•×¨×™×”</label>
                    <select id="edit_category" required>
                        <option value="strollers">×¢×’×œ×•×ª</option>
                        <option value="cribs">×¢×¨×™×¡×•×ª</option>
                        <option value="car seats">××•×©×‘×™ ×‘×˜×™×—×•×ª</option>
                        <option value="toys">×¦×¢×¦×•×¢×™×</option>
                        <option value="baby beds">××™×˜×ª ×ª×™× ×•×§</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit_description">×ª×™××•×¨</label>
                    <textarea id="edit_description" rows="3" maxlength="200" required></textarea>
                </div>

                <div class="form-group">
                    <label for="edit_donator_username">××™××™×™×œ ×©×œ ×”×ª×•×¨×</label>
                    <input type="username" id="edit_donator_username" required>
                </div>

                <div class="form-group">
                    <label for="edit_status">×¡×˜×˜×•×¡ (×œ×§×¨×™××” ×‘×œ×‘×“)</label>
                    <input type="text" id="edit_status" readonly 
                           style="background-color: #f0f0f0; 
                                  border: 1px solid #ccc; 
                                  color: #666; 
                                  cursor: not-allowed; 
                                  font-weight: bold; 
                                  text-align: center;">
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="submit" class="btn-primary" style="flex:1">ğŸ’¾ ×©××•×¨</button>
                    <button type="button" onclick="document.getElementById('editModal').style.display='none'" class="btn-cancel">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="donationModal" class="modal">
        <div class="modal-content">
            <h3>××™×©×•×¨ ×ª×¨×•××” ×—×“×©×”</h3>
            <form id="approveDonationForm">
                <input type="hidden" id="don_id">
                <div class="form-group">
                    <label>×©× ×”××•×¦×¨</label>
                    <input type="text" id="don_name" required>
                </div>
                <div class="form-group">
                    <label>×§×˜×’×•×¨×™×”</label>
                    <select id="don_category" required>
                        <option value="strollers">×¢×’×œ×•×ª</option>
                        <option value="cribs">×¢×¨×™×¡×•×ª</option>
                        <option value="car seats">××•×©×‘×™ ×‘×˜×™×—×•×ª</option>
                        <option value="toys">×¦×¢×¦×•×¢×™×</option>
                        <option value="baby beds">××™×˜×ª ×ª×™× ×•×§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×ª×™××•×¨</label>
                    <textarea id="don_description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>×©× ×”××©×ª××© ×©×œ ×”×ª×•×¨×</label>
                    <input type="username" id="don_username" required>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="submit" class="btn-approve" style="flex:1">×©××•×¨ ×•××©×¨ ×ª×¨×•××” âœ…</button>
                    <button type="button" onclick="document.getElementById('donationModal').style.display='none'" class="btn-cancel">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>

    
    <script>
        const API_URL = "https://levkatan-api-dxh8azfdfua6e9gn.israelcentral-01.azurewebsites.net/api";
        const token = localStorage.getItem('userToken');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('userRole');

        let allInventory = [];

        // --- AUTH & THEME ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        if(!token) window.location.href = 'login_page.html';
        document.getElementById('userGreeting').innerText = username;
        if(role === 'admin') document.getElementById('dynamicNav').innerHTML = `<a href="admin_dashboard.html" class="nav-item">ğŸ”’ × ×™×”×•×œ ××“××™×Ÿ</a>`;

        function logout() { localStorage.clear(); window.location.href = 'login_page.html'; }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(event) event.target.classList.add('active');
        
            document.getElementById('inventory-view').style.display = tabId === 'inventory' ? 'block' : 'none';
            document.getElementById('requests-view').style.display = tabId === 'requests' ? 'block' : 'none';
            document.getElementById('donations-view').style.display = tabId === 'donations' ? 'block' : 'none';
            document.getElementById('extensions-view').style.display = tabId === 'extensions' ? 'block' : 'none';
            
            if(tabId === 'inventory') loadProducts();
            if(tabId === 'requests') loadRequests();
            if(tabId === 'donations') loadDonations();
            if(tabId === 'extensions') loadExtensionRequests();
        }

        // --- ADD MODAL & LOGIC ---

        function openAddModal() {
            document.getElementById('addProductModal').style.display = 'block';
            loadUsernamesForDropdown(); // Fetch usernames when modal opens
        }

        function toggleOrgDonation() {
            const checkbox = document.getElementById('orgCheckbox');
            const usernameInput = document.getElementById('donator_username');
            const ORG_STR = "×¢××•×ª×ª ×œ×‘ ×§×˜×Ÿ"; // Default Org donation string

            if (checkbox.checked) {
                usernameInput.value = ORG_STR;
                usernameInput.readOnly = true;
                usernameInput.style.backgroundColor = "#f0f0f0";
            } else {
                usernameInput.value = "";
                usernameInput.readOnly = false;
                usernameInput.style.backgroundColor = "var(--bg-color)";
            }
        }

        async function loadUsernamesForDropdown() {
            // Note: In current app.py, only admins can access /api/admin/users. 
            // If the current user is an employee, this might return 403. 
            // We catch the error silently so the rest of the form still works.
            if(role !== 'admin') return; 

            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const users = await res.json();
                    const dataList = document.getElementById('usernamesList');
                    dataList.innerHTML = users.map(u => `<option value="${u.username}">`).join('');
                }
            } catch (e) {
                console.log("Could not load user list (requires admin)");
            }
        }

        // --- INVENTORY LOGIC ---
        async function loadProducts() {
            const res = await fetch(`${API_URL}/employee/products`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            allInventory = await res.json();
            renderInventory(allInventory);
        }

        function filterProducts() {
            const selectedCat = document.getElementById('filterCategory').value;
            const selectedStatus = document.getElementById('filterStatus').value;

            const filtered = allInventory.filter(p => {
                const matchCat = (selectedCat === 'all' || p.category === selectedCat);
                const matchStatus = (selectedStatus === 'all' || p.status === selectedStatus);
                return matchCat && matchStatus;
            });

            renderInventory(filtered);
        }

        function renderInventory(products) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map(p => {
                const borrowerInfo = p.status === 'borrowed' && p.borrower_name 
                    ? `<span style="color: #E05297; font-weight: bold;"> ${p.borrower_name}</span>` 
                    : "-";
        
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.product_name}</td>
                        <td>${p.category}</td>
                        <td class="status-cell">${p.status}</td>
                        <td>${borrowerInfo}</td> <td>
                            <button class="btn-edit" onclick="editProduct(${p.id})">×¢×¨×•×š âœï¸</button>
                            <button class="btn-delete" onclick="deleteProduct(${p.id})">××—×§ ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if(products.length === 0) tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>××™×Ÿ ××•×¦×¨×™× ×ª×•×××™× ×œ×¤×™×œ×˜×¨ ğŸ”</td></tr>";
        }

        // Add Product Submit
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newProduct = {
                product_name: document.getElementById('product_name').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                donator_username: document.getElementById('donator_username').value,
            };

            const res = await fetch(`${API_URL}/employee/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(newProduct)
            });

            if (res.status === 201) {
                alert("××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!");
                document.getElementById('productForm').reset();
                document.getElementById('addProductModal').style.display = 'none'; // Close modal
                toggleOrgDonation(); // Reset styles
                loadProducts();
            } else {
                alert("×©×’×™××” ×‘×”×•×¡×¤×”");
            }
        });

        // Delete Product
        async function deleteProduct(id) {
            if (!confirm(`×œ××—×•×§ ××ª ××•×¦×¨ ID ${id}?`)) return;
            const res = await fetch(`${API_URL}/employee/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.status === 204) loadProducts();
            else alert("×©×’×™××” ×‘××—×™×§×”");
        }

        // --- EDIT LOGIC ---
        async function editProduct(id) {
            const res = await fetch(`${API_URL}/employee/products/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(!res.ok) return alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”××•×¦×¨");

            const product = await res.json();
            document.getElementById('edit_id').value = product.id;
            document.getElementById('editProductId').innerText = `(ID: ${product.id})`;
            document.getElementById('edit_product_name').value = product.product_name;
            document.getElementById('edit_category').value = product.category;
            document.getElementById('edit_description').value = product.description;
            document.getElementById('edit_donator_username').value = product.donator_username;

            const statusTranslations = {
                'available': '×–××™×Ÿ',
                'borrowed': '××•×©××œ',
                'unavailable': '×œ× ×–××™×Ÿ',
                'confirmation_pending': '×××ª×™×Ÿ ×œ××™×©×•×¨'
            };
            
            document.getElementById('edit_status').value = statusTranslations[product.status] || product.status;
            document.getElementById('editModal').style.display = 'block';
        }

        document.getElementById('editProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('edit_id').value;
            const updatedProduct = {
                product_name: document.getElementById('edit_product_name').value,
                category: document.getElementById('edit_category').value,
                description: document.getElementById('edit_description').value,
                donator_username: document.getElementById('edit_donator_username').value,
            };

            const res = await fetch(`${API_URL}/employee/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(updatedProduct)
            });

            if (res.ok) {
                document.getElementById('editModal').style.display = 'none';
                loadProducts();
            } else {
                alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ");
            }
        });

        // --- REQUESTS, DONATIONS, EXTENSIONS (Existing Logic) ---
        async function loadRequests() {
            const res = await fetch(`${API_URL}/employee/requests`, { headers: { 'Authorization': `Bearer ${token}` }});
            if(res.status === 403) return;
            const reqs = await res.json();
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = reqs.map(r => `
                <tr>
                    <td>${r.username}</td>
                    <td>${r.product}</td>
                    <td>${r.date.split(' ')[0]}</td>
                    <td style="color: #FF69B4; font-weight: bold;">${r.returned_date}</td> 
                    <td>
                        <button class="btn-approve" onclick="updateStatus(${r.id}, 'approved')">××©×¨ âœ…</button>
                        <button class="btn-reject" onclick="updateStatus(${r.id}, 'rejected')">×“×—×” âŒ</button>
                    </td>
                </tr>
            `).join('');
            if(reqs.length === 0) tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª</td></tr>";
        }

        async function updateStatus(id, status) {
            await fetch(`${API_URL}/employee/requests/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status })
            });
            loadRequests();
        }

        async function loadDonations() {
            const res = await fetch(`${API_URL}/employee/donations`, { headers: { 'Authorization': `Bearer ${token}` }});
            const dons = await res.json();
            document.getElementById('donationsTableBody').innerHTML = dons.map(d => `
                <tr>
                    <td>${d.created_at.split(' ')[0]}</td>
                    <td>${d.product_name}</td>
                    <td>${d.donator_username}</td>
                    <td>
                        <button class="btn-edit" onclick="openApproveDonation(${JSON.stringify(d).replace(/"/g, '&quot;')})">×¢×¨×•×š ×•××©×¨ âœï¸</button>
                        <button class="btn-reject" onclick="rejectDonation(${d.id})">×“×—×” âŒ</button>
                    </td>
                </tr>
            `).join('');
        }

        function openApproveDonation(don) {
            document.getElementById('don_id').value = don.id;
            document.getElementById('don_name').value = don.product_name;
            document.getElementById('don_category').value = don.category;
            document.getElementById('don_description').value = don.description;
            document.getElementById('don_username').value = don.donator_username;
            document.getElementById('donationModal').style.display = 'block';
        }

        document.getElementById('approveDonationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('don_id').value;
            const data = {
                product_name: document.getElementById('don_name').value,
                category: document.getElementById('don_category').value,
                description: document.getElementById('don_description').value,
                donator_username: document.getElementById('don_username').value
            };
            const res = await fetch(`${API_URL}/employee/donations/${id}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });
            if(res.ok) {
                alert("×”×ª×¨×•××” ××•×©×¨×” ×•×”×ª×•×•×¡×¤×” ×œ××œ××™!");
                document.getElementById('donationModal').style.display = 'none';
                loadDonations();
            }
        });

        async function rejectDonation(id) {
            if(!confirm("×”×× ×œ××—×•×§ ×‘×§×©×ª ×ª×¨×•××” ×–×•?")) return;
            await fetch(`${API_URL}/employee/donations/${id}/reject`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
            loadDonations();
        }

        async function loadExtensionRequests() {
            const res = await fetch(`${API_URL}/employee/extensions`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            const tbody = document.getElementById('extensionsTableBody');
            if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>××™×Ÿ ×‘×§×©×•×ª ×”××¨×›×” ×××ª×™× ×•×ª</td></tr>"; return; }
            tbody.innerHTML = data.map(ext => `
                <tr>
                    <td>${ext.username}</td>
                    <td>${ext.product_name}</td>
                    <td style="color: grey;">${ext.current_return_date}</td>
                    <td style="color: var(--brand-pink); font-weight: bold;">${ext.new_return_date}</td>
                    <td>
                        <button class="btn-approve" onclick="handleExtension(${ext.id}, 'approved')">××©×¨ âœ…</button>
                        <button class="btn-reject" onclick="handleExtension(${ext.id}, 'rejected')">×“×—×” âŒ</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function handleExtension(extId, status) {
            const res = await fetch(`${API_URL}/employee/extensions/${extId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status: status })
            });
            if(res.ok) {
                alert(status === 'approved' ? "×”×ª××¨×™×š ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”" : "×”×‘×§×©×” × ×“×—×ª×”");
                loadExtensionRequests();
            }
        }

        // Close Modals on click outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = "none";
            }
        }

        // Init
        loadProducts();
        loadRequests();
        loadDonations();
    </script>
</body>
</html>
