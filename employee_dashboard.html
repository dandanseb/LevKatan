<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ×¢×•×‘×“×™× - ×œ×‘ ×§×˜×Ÿ</title>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        /* Shared variables for Unified Look */
        :root {
            --bg-color: #E0F7FA; /* Slightly blueish default */
            --header-bg: white;
            --text-color: #333;
            --card-bg: white;
            --nav-btn-bg: #f0f0f0;
            --nav-btn-text: #555;
            --nav-btn-hover: #e0e0e0;
            --border-color: #ddd;
            --table-head-bg: #f9f9f9;
        }
        body.dark-mode {
            --bg-color: #121212;
            --header-bg: #1E1E1E;
            --text-color: #E0E0E0;
            --card-bg: #2D2D2D;
            --nav-btn-bg: #333;
            --nav-btn-text: #ddd;
            --nav-btn-hover: #444;
            --border-color: #444;
            --table-head-bg: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; transition: background 0.3s; }

        /* Layout Structure */
        .top-bar {
            background: var(--header-bg); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        .brand-area { display: flex; align-items: center; gap: 10px; }
        .brand-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .nav-actions { display: flex; align-items: center; gap: 10px; }
        .nav-item {
            text-decoration: none;
            color: var(--nav-btn-text);
            font-size: 14px;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--nav-btn-bg);
            transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .nav-item:hover { background: var(--nav-btn-hover); color: var(--text-color); }

        .theme-toggle { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; border-radius: 50%; margin-left: 10px; color: var(--text-color); }
        .theme-toggle:hover { background: rgba(128,128,128,0.2); }

        /* Main Content Grid for Two Boxes */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px; /* Space between the two boxes */
            padding: 0 20px 30px 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            flex: 1; /* Prend la mÃªme largeur */
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        th { background-color: var(--table-head-bg); color: #006064; font-weight: bold; }
        body.dark-mode th { color: #80DEEA; }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            background: var(--bg-color);
            color: var(--text-color);
        }
        .form-group textarea { resize: vertical; }

        /* Button Styles */
        .btn { background: #00796B; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: bold; width: 100%; }
        .btn:hover { background: #004D40; }
        .btn-delete { background: #EF5350; margin-right: 5px; }
        .btn-delete:hover { background: #D32F2F; }
        .btn-edit { background: #FFA000; margin-right: 5px; }
        .btn-edit:hover { background: #FF8F00; }
        .logout-btn { background: #FF4444; color: white; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .logout-btn:hover { background: #D32F2F; }
        .btn-approve { background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition:0.2s; }
        .btn-approve:hover { background: #388E3C; }
        .btn-reject { background: #EF5350; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition:0.2s; margin-right: 5px; }
        .btn-reject:hover { background: #D32F2F; }

    </style>
</head>
<body>
    <div class="top-bar">
        <div class="brand-area">
            <img src="logo.png" alt="Logo" class="brand-logo">
            <h2 style="margin:0; font-size: 20px; color:var(--text-color);">×××©×§ ×¢×•×‘×“</h2>
        </div>
        <div class="nav-actions">
            <span id="dynamicNav"></span>

            <a href="user_dashboard.html" class="nav-item">ğŸª‘ ×§×˜×œ×•×’</a>
            <span id="userGreeting" style="margin: 0 5px; font-weight:600; color:var(--text-color); opacity:0.7;"></span>

            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
            <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="main-content">

        <div class="card" style="flex: 2;"> <h3>ğŸ› ï¸ × ×™×”×•×œ ×¤×¨×™×˜×™× (Products Management)</h3>

            <form id="productForm">
                <h4>â• ×”×•×¡×£ ×¤×¨×™×˜ ×—×“×©</h4>
                <div class="form-group">
                    <label for="product_name">×©× ×”××•×¦×¨</label>
                    <input type="text" id="product_name" required>
                </div>
                <div class="form-group">
                    <label for="category">×§×˜×’×•×¨×™×”</label>
                    <select id="category" required>
                        <option value="" disabled selected>×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                        <option value="cribs">cribs</option>
                        <option value="baby beds">baby beds</option>
                        <option value="strollers">strollers</option>
                        <option value="babycar seats">babycar seats</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">×ª×™××•×¨ (×¢×“ 15 ××™×œ×™×)</label>
                    <textarea id="description" rows="3" maxlength="200" required></textarea>
                </div>
                <div class="form-group">
                    <label for="donator_email">××™××™×™×œ ×©×œ ×”×ª×•×¨× (Donator Email)</label>
                    <input type="email" id="donator_email" required>
                </div>

                <button type="submit" class="btn">×”×•×¡×£ ××•×¦×¨</button>

            </form>

            <h4 style="margin-top: 30px;">×¨×©×™××ª ×›×œ ×”××•×¦×¨×™×</h4>
            <table id="productsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>×©×</th>
                        <th>×§×˜×’×•×¨×™×”</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    </tbody>
            </table>
        </div>

        <div class="card" style="flex: 1;">
            <h3>ğŸ ×‘×§×©×•×ª ×”×©××œ×” ×××ª×™× ×•×ª ×œ××™×©×•×¨</h3>
            <table id="requestsTable">
                <thead>
                    <tr>
                        <th>×©× ×”××©×ª××©</th>
                        <th>×”××•×¦×¨</th>
                        <th>×ª××¨×™×š ×‘×§×©×”</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = "https://levkatan-api-dxh8azfdfua6e9gn.israelcentral-01.azurewebsites.net/api";
        const token = localStorage.getItem('userToken');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('userRole');

        // --- Theme Logic ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        // -------------------

        if(!token) window.location.href = 'index.html';
        document.getElementById('userGreeting').innerText = username;

        // Dynamic Nav with Unified Style
        if(role === 'admin') {
            document.getElementById('dynamicNav').innerHTML = `<a href="admin_dashboard.html" class="nav-item">ğŸ”’ × ×™×”×•×œ ××“××™×Ÿ</a>`;
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }


        // ====================================================================
        // REQUEST MANAGEMENT
        // ====================================================================

        async function loadRequests() {
            const res = await fetch(`${API_URL}/employee/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.status === 403) { alert("××™×Ÿ ×œ×š ×’×™×©×”!"); window.location.href = 'index.html'; return; }

            const reqs = await res.json();
            const tbody = document.getElementById('requestsTableBody'); // RenommÃ© ici
            tbody.innerHTML = reqs.map(r => `
                <tr>
                    <td>${r.username}</td>
                    <td>${r.product}</td>
                    <td>${r.date.split(' ')[0]}</td>
                    <td>
                        <button class="btn-approve" onclick="updateStatus(${r.id}, 'approved')">××©×¨ âœ…</button>
                        <button class="btn-reject" onclick="updateStatus(${r.id}, 'rejected')">×“×—×” âŒ</button>
                    </td>
                </tr>
            `).join('');
            if(reqs.length === 0) tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px;'>××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª ×›×¨×’×¢ ğŸ‰</td></tr>";
        }

        async function updateStatus(id, status) {
            await fetch(`${API_URL}/employee/requests/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status })
            });
            loadRequests();
        }

        // ====================================================================
        // PRODUCT MANAGEMENT
        // ====================================================================

        // Step 1: Load the product list
        async function loadProducts() {
            const res = await fetch(`${API_URL}/employee/products`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(!res.ok) { console.error("Product loading error"); return; }

            const products = await res.json();
            renderProducts(products);
        }

        // Step 2: Submit the list to the table
        function renderProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.product_name}</td>
                    <td>${p.category}</td>
                    <td>${p.status}</td>
                    <td>
                        <button class="btn-edit" onclick="editProduct(${p.id})">×¢×¨×•×š âœï¸</button>
                        <button class="btn-delete" onclick="deleteProduct(${p.id})">××—×§ ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
            if(products.length === 0) tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>××™×Ÿ ××•×¦×¨×™× ×¨×©×•××™× ×›×¨×’×¢.</td></tr>";
        }

        // Step 3: Add a product (Managed via the form)
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newProduct = {
                product_name: document.getElementById('product_name').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                donator_email: document.getElementById('donator_email').value,
            };

            const res = await fetch(`${API_URL}/employee/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(newProduct)
            });

            if (res.status === 201) {
                alert("××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!");
                document.getElementById('productForm').reset(); // Clear the form
                loadProducts(); // Reload the list
            } else {
                alert("×©×’×™××” ×‘×”×•×¡×¤×ª ×”××•×¦×¨.");
            }
        });

        // Step 4: Removing a product
        async function deleteProduct(id) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××•×¦×¨ ID ${id}?`)) return;

            const res = await fetch(`${API_URL}/employee/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.status === 204) {
                alert("××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”!");
                loadProducts();
            } else {
                alert("×©×’×™××” ×‘××—×™×§×ª ×”××•×¦×¨.");
            }
        }

        // Step 5: Modifying a product (Requires a Modal/Inline form, not implemented here, but the link is there)
        function editProduct(id) {
            alert(`×‘×§×©×” ×œ×¢×¨×™×›×ª ××•×¦×¨ ID ${id}. ×™×™×©×•× ×”×¢×¨×™×›×” ×™×ª×‘×¦×¢ ×‘×©×œ×‘ ×”×‘×.`);
            // Nous allons implÃ©menter la fonction d'Ã©dition plus tard.
        }


        // Initial loading of both sections
        loadRequests();
        loadProducts();
    </script>
</body>
</html>
